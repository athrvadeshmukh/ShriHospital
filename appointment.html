<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Book Appointment - Shri Hospital</title>
    <link rel="stylesheet" href="assets/css/style-starter.css">
    <style>
      .container-small{max-width:760px;margin:28px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 20px 40px rgba(0,0,0,0.06)}
      .input-sm{padding:10px;border-radius:6px;border:1px solid #e6eaef;width:100%}
      .form-row{display:flex;gap:12px}
      .form-row .col{flex:1}
      @media(max-width:600px){.form-row{flex-direction:column}}
      #appointToast{position:fixed;top:20px;right:20px;background:var(--primary,#007bff);color:#fff;padding:12px 16px;border-radius:8px;display:none;z-index:10000}
      .muted{color:#6c757d;font-size:14px}
    </style>
  </head>
  <body>

    <nav class="navbar navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="index.html"><img src="assets/images/award.png" width="40" alt="Shri Hospital"> Shri Hospital</a>
        <div>
          <a class="btn btn-outline" href="services.html">Back to Services</a>
          <a class="btn btn-outline" href="appointment.html">Book Appointment</a>
        </div>
      </div>
    </nav>

    <main class="container">
      <div class="container-small">
        <h2>Book an Appointment</h2>
        <p class="muted">Enter your details below. We'll save your booking to the hospital appointment register.</p>

        <form id="appointmentForm">
          <div class="form-row">
            <div class="col">
              <label for="name">Full name*</label>
              <input type="text" id="name" name="name" class="input-sm" required>
            </div>
            <div class="col">
              <label for="email">Email*</label>
              <input type="email" id="email" name="email" class="input-sm" required>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="form-row">
            <div class="col">
              <label for="phone">Phone*</label>
              <input type="tel" id="phone" name="phone" class="input-sm" required>
            </div>
            <div class="col">
              <label for="department">Department*</label>
              <select id="department" name="department" class="input-sm" required>
                <option value="">Choose department</option>
                <option>Cardiology</option>
                <option>Dentistry</option>
                <option>Orthopaedics</option>
                <option>General Surgery</option>
                <option>Urology</option>
              </select>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="form-row">
            <div class="col">
              <label for="date">Date*</label>
              <input type="date" id="date" name="date" class="input-sm" required>
            </div>
            <div class="col">
              <label for="time">Time*</label>
              <input type="time" id="time" name="time" class="input-sm" required>
            </div>
          </div>

          <div style="height:12px"></div>

          <div>
            <label for="message">Additional details</label>
            <textarea id="message" name="message" rows="4" class="input-sm" placeholder="Any symptoms or notes (optional)"></textarea>
          </div>

          <div style="height:14px"></div>

          <div style="display:flex;gap:10px;justify-content:flex-end">
            <button type="reset" class="btn btn-outline">Clear</button>
            <button type="submit" id="submitBtn" class="btn btn-primary">Book Appointment</button>
          </div>
        </form>

        <div style="height:18px"></div>
        <div class="muted">This form will save your appointment to the connected Google Spreadsheet. If you haven't deployed the Google Apps Script connector, the form will store the booking locally in your browser.</div>

      </div>
    </main>

    <div id="appointToast">Your appointment is booked successfully</div>

    <script>
    // Replace with your deployed Google Apps Script web app URL
    const WEB_APP_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYED_WEB_APP_ID/exec';

    const form = document.getElementById('appointmentForm');
    const toast = document.getElementById('appointToast');

    function showToast(msg){ toast.textContent = msg || 'Your appointment is booked successfully'; toast.style.display = 'block'; toast.style.opacity = '1'; setTimeout(()=>{ toast.style.opacity='0'; setTimeout(()=>{ toast.style.display='none'; },400); },2500); }

    form.addEventListener('submit', function(e){
      e.preventDefault();
      const data = {
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        department: document.getElementById('department').value,
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        message: document.getElementById('message').value.trim()
      };

      // Basic validation
      if(!data.name || !data.email || !data.phone || !data.department || !data.date || !data.time){
        alert('Please fill all required fields.');
        return;
      }

      // Try to send to Google Apps Script web app
      fetch(WEB_APP_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(res => res.json()).then(resJson => {
        // Always save locally so patients.html can display the booking for doctors
        try{ localFallbackSave(data); } catch(e){ console.warn('local save failed', e); }

        // trigger storage event for other tabs (some browsers do not fire it on same window)
        try{ localStorage.setItem('shri_appointments_last_update', new Date().toISOString()); }catch(e){}

        if(resJson && resJson.status === 'success'){
          showToast('Your appointment is booked successfully');
          form.reset();
          console.log('Saved to sheet', resJson);
        } else {
          // fallback (already saved locally)
          showToast('Saved locally — Apps Script did not return success');
        }
      }).catch(err => {
        // network or CORS error — fallback to local save
        console.warn('Could not post to web app', err);
        localFallbackSave(data);
        try{ localStorage.setItem('shri_appointments_last_update', new Date().toISOString()); }catch(e){}
        showToast('Saved locally (offline mode)');
      });
    });

    function localFallbackSave(data){
      try{
        const key = 'shri_appointments';
        const existing = JSON.parse(localStorage.getItem(key) || '[]');
        existing.push(Object.assign({savedAt:new Date().toISOString()}, data));
        localStorage.setItem(key, JSON.stringify(existing));
        console.log('Saved locally', data);
      }catch(e){ console.error('local save failed', e); }
    }
    </script>

  </body>
</html>
